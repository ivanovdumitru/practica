var TableForm;TableForm=function(){function t(t){var e,n,i,a;this.edit=!1,this.form=$('<div class="form" />'),this.table=null,this.pinned=!1,this.formData=null,this.getData=null,this.request=null,this.fields=[],this.actions=[],this.template=swig.compile('<form{% for attr, value in form.attrs %} {{attr}}="{{value}}"{% endfor %}> {% if form.name %}<p class="name {{form.name.attrs.class}}">{{form.name.label}}</p>{% endif %} {% for field in fields %} {% if field.type == "hidden" %}<input type="hidden" name="{{field.name}}" value="{{field.value}}" />{% else %} <div class="field{% if field.fields.length > 1 %} multiple{% endif %}{% if field.attrs.class %} {{field.attrs.class}}{% endif %}">{% if field.group %}<p class="group{% if field.group.class %} {{field.group.class}}{% endif %}">{% if field.group.label %}{{field.group.label}}{% else %}{{field.group}}{% endif %}</p>{% endif %}{% for input in field.fields %}{% if input.label and (not input.label.position or input.label.position and input.label.position == "before") %} <label for="{{_prefix}}input_{{input.name}}"{% if input.label.class or input.required %} class="{% if input.required %}required{% endif %}{% if input.label.class %} {{input.label.class}}{% endif %}"{% endif %}>{% if input.label.text %}{{input.label.text}}{% else %}{{input.label}}{% endif %}</label>{% endif %}{% if input.type == "textarea" %} <textarea id="{{_prefix}}input_{{input.name}}" name="{{input.name}}" {% for attr, value in input.attrs %} {{attr}}="{{value}}"{% endfor %}{% if input.length %} data-length="{{input.length}}"{% endif %}>{{input.value}}</textarea>{% elif input.type == "date" %} <div class="date-picker" id="{{_prefix}}input_{{input.name}}"><input type="text" name="{{input.name}}" value="{{input.value}}" {% for attr, value in input.attrs %} {{attr}}="{{value}}"{% endfor %} /></div>{% elif input.type == "time" %} <div class="time-picker" id="{{_prefix}}input_{{input.name}}"><input type="text" name="{{input.name}}" value="{{input.value}}"/></div>{% elif input.type == "select" %} <select id="{{_prefix}}input_{{input.name}}" name="{{input.name}}" {% for attr, value in input.attrs %} {{attr}}="{{value}}"{% endfor %}>{% for value, label in input.options %}<option value="{{value}}"{% if value == input.value %} selected="selected"{% endif %}>{{label}}</option>{% endfor %}</select>{% elif input.type == "related" %} <input type="hidden" id="{{_prefix}}input_{{input.name}}" name="{{input.name}}" data-select="related" value="{{input.value}}" data-text="{{input.text}}" data-url="{{input.url}}" data-placeholder="{{input.placeholder}}" data-order="{{input.order}}" data-results=\'{{input.results}}\'{% if input.related %} data-related=\'{{input.related|json}}\'{% endif %}{% if input.children %} data-children=\'{{input.children|json}}\'{% endif %}{% for attr, value in input.attrs %} {{attr}}="{{value}}"{% endfor %}/>{% elif input.type == "checkbox" %} <input type="checkbox" id="{{_prefix}}input_{{input.name}}" name="{{input.name}}"{% if input.value %} checked="checked" {% endif %}{% for attr, value in input.attrs %} {{attr}}="{{value}}"{% endfor %} />{% elif input.type == "text" or input.type == "digits" %} <input type="text" id="{{_prefix}}input_{{input.name}}" name="{{input.name}}" value="{{input.value}}" data-type="{{input.type}}"{% if input.length %} data-length="{{input.length}}"{% endif %}{% for attr, value in input.attrs %} {{attr}}="{{value}}"{% endfor %} />{% else %} <input type="{{input.type}}" id="{{_prefix}}input_{{input.name}}" name="{{input.name}}" value="{{input.value}}"{% for attr, value in input.attrs %} {{attr}}="{{value}}"{% endfor %}{% if input.length %} data-length="{{input.length}}"{% endif %} />{% endif %}{% if input.label and (input.label.position and input.label.position == "after") %} <label for="{{_prefix}}input_{{input.name}}"{% if input.label.class or input.required %} class="{% if input.required %}required{% endif %}{% if input.label.class %} {{input.label.class}}{% endif %}"{% endif %}>{% if input.label.text %}{{input.label.text}}{% else %}{{input.label}}{% endif %}</label>{% endif %}{% endfor %} <span class="error-text"></span></div>{% endif %}{% endfor %}{% if actions.length %}{% for action in actions %} <button type="button" class="btn btn-{{action.id}}{% if action.class %} {{action.class}}{% endif %}"{% for attr, value in action.attrs %} {{attr}}="{{value}}"{% endfor %}>{{action.label}}</button>{% endfor %}{% else %} <button type="button" class="btn btn-success btn-ok">Ok</button> <button type="button" class="btn btn-danger btn-cancel">Cancel</button>{% endif %}</form>'),i=this.constructor["default"];for(n in i)a=i[n],this[n]=a;for(e in t)e in this&&(this[e]=t[e]);if(null!=this.formData.attrs&&this.formData.attrs.id)this.prefix=this.formData.attrs.id;else for(this.prefix="uid_"+this.uid();$("[id^='"+this.prefix+"']").length;)this.prefix="uid_"+this.uid()}return t.VERSION="2.2.6",t["default"]={contentType:!1,actionNotification:!0,datePickerOptions:{dateFormat:"dd/mm/yy"},timePickerOptions:{parse:"loose",timeFormat:"HH:mm:ss"},loadLength:50,after:null,onSubmit:null,onComplete:null,onCancel:null,onActionNotification:null,onDelete:null,sendCSRFTokenHeader:!0},t.prototype.getCsrfToken=function(){var t,e,n,i;for(i="csrftoken=",e=document.cookie.split(";"),n=0;n<e.length;){for(t=e[n];" "===t.charAt(0);)t=t.substring(1,t.length);if(0===t.indexOf(i))return t.substring(i.length,t.length).replace(/"/g,"");n++}return e},t.prototype.uid=function(){return Math.floor(4294967296*(1+Math.random())).toString(16).substring(1)},t.prototype.bindForm=function(){var t,e,n,i,a;for(a=this,this.form.find(":input").change(function(){a.form.closest("tr").addClass("edited")}),this.form.on("focus","input, textarea",function(){try{this.setSelectionRange(0,this.value.length)}catch(t){}}),this.form.on("keypress","input, textarea",function(t){var e,n;if(n=$(t.target),null!=n.data("length")&&n.val().length>=parseInt(n.data("length")))return!1;if(null!=n.data("type"))switch(n.data("type")){case"digits":if(e=null!=t.charCode?t.charCode:t.keyCode,e&&(e>57||48>e))return!1}}),this.form.on("keyup","input",function(t){var e;return 13===t.keyCode?(e=$(t.target).nextAll("input, textarea, select").not(".skip-focus").first(),e.length||(e=$(t.target).closest(".field").nextAll(".field").not(".skip-focus").first().find("input, textarea, select")),e.length||(e=a.form.find(".btn-ok")),e.first().focus()):void 0}),null!=$.fn.datepicker&&(this.form.find(".date-picker input").datepicker(this.datePickerOptions),this.form.find(".date-picker").click(function(){$(this).find("input").datepicker("show")})),null!=$.fn.timepicker&&(this.form.find(".time-picker input").timepicker(this.timePickerOptions),this.form.find(".time-picker").click(function(){$(this).find("input").timepicker("show")})),this.form.find("[data-select=related]").each(function(){return $(this).select2($.extend(!0,$(this).data("options")?$(this).data("options"):{},{initSelection:function(t,e){var n,i;i=t.data(),n={id:t.val(),text:i.text},e(n)},query:function(t){var e,n,i;i=t.element.data(),e={more:!1,results:[]},n=null!=i.related?"object"==typeof i.related?$.extend({},i.related):{related:i.related}:{},n.select=!0,n.ordering=i.order,n.text=t.term,n.start=(t.page-1)*a.loadLength,n.length=a.loadLength,n[i.results.term]=t.term,$.getJSON(i.url,n,function(n){var l,r,o;for(e.more=n.length===a.loadLength,r=0,o=n.length;o>r;r++)l=n[r],null!=i.format&&(l=i.format(l)),e.results.push({id:l[i.results.id].toString(),text:l[i.results.text].toString()});t.callback(e)})}})).change(function(t){var e,n,i,l,r,o,s,u,f,d,p,c;if(i=$(t.target),u=i.data(),null!=u.children)for(o=u.children,l=0,r=o.length;r>l;l++){e=o[l],d=a.form.find("[name="+e+"]"),f=d.data(),null!=u.results.reference&&null!=f.related&&"object"==typeof f.related?f.related[u.results.reference]=i.val():f.related=i.val(),null==f.relatedElements&&(f.relatedElements={}),f.relatedElements[i.attr("name")]=!!i.val(),d.data(f),null!=t.added&&d.select2("val","").trigger("change"),n=!1,s=f.relatedElements;for(p in s)c=s[p],c||(n=!0);d.prop("disabled",n)}}).trigger("change")}),this.form.find(".btn-cancel").click(function(){var t;(null==a.onCancel||(t=a.onCancel(a),null==t||t))&&null!=a.table&&a.table.closeRowContainer(a.form.closest("tr.row-content").index())}),this.form.find(".btn-ok").click(function(){a.sendData()}),i=this.actions,e=0,n=i.length;n>e;e++)t=i[e],null!=t.callback&&!function(t){a.form.find(".btn-"+t.id).click(function(){t.callback(a)})}(t);this.form.on("submit",function(){return a.sendData(),!1})},t.prototype.render=function(){var t,e,n,i,a,l,r,o,s,u,f;if(n=this,this.edit&&!this.form.html()&&null==this.request)this.form.html($("<em />").text("Loading form data")),this.formData.attrs.action=""+this.formData.attrs.action+this.edit+"/",this.loadData();else{for(e=[],s=this.fields,a=0,r=s.length;r>a;a++)for(t=s[a],null!=t.type&&"hidden"===t.type&&e.push(t),t instanceof Array?e.push({fields:t}):null==t.fields?e.push({fields:[t]}):e.push(t),u=e[e.length-1].fields,l=0,o=u.length;o>l;l++)i=u[l],"related"===i.type&&null!=i.children&&"string"==typeof i.children&&(i.children=[i.children]),null!=i.value&&("date"===i.type&&null!=$.fn.datepicker&&"Invalid Date"!==new Date(i.value).toString()&&(i.value=$.datepicker.formatDate(this.datePickerOptions.dateFormat,new Date(i.value))),"time"===i.type&&null!=$.fn.timepicker&&(f=new Date(i.value),"Invalid Date"===f.toString()&&i.value.match(/(\d{2})(\.\d{3})?/g)&&(f=new Date((new Date).toISOString().substr(0,11)+i.value.match(/(\d{2})(\.\d{3})?/g).join(":")+"Z")),"Invalid Date"!==f.toString()&&(i.value=$.datepicker.formatTime(this.timePickerOptions.timeFormat,{hour:f.getUTCHours(),minute:f.getUTCMinutes(),second:f.getUTCSeconds()}))));this.form.html($(this.template({form:this.formData,fields:e,actions:this.actions,_prefix:this.prefix+"_"}))),this.bindForm(),null!=this.table&&this.form.closest(".row-content").length&&this.table.scrollRowContainer(this.form.closest(".row-content")),setTimeout(function(){n.form.find(".auto-focus").length?n.form.find(".auto-focus").focus():n.form.find(":input:visible:not([disabled]):first").focus(),null!=n.after&&n.after(n)},0)}return this.form},t.prototype.delData=function(){var t,e,n;if(n=this,e=function(){var t;t=[],n.formData.attrs.action=""+n.formData.attrs.action+n.edit+"/",n.request=$.ajax({url:n.formData.attrs.action,data:JSON.stringify(t),type:null!=n.formData.attrs.method?n.formData.attrs.method:"DELETE",contentType:null!=n.formData.contentType?n.formData.contentType:n.contentType,dataType:"json",headers:n.sendCSRFTokenHeader?{"X-CSRFToken":n.getCsrfToken()}:{},complete:function(t){var e;return n.request=null,n.actionNotification&&null!=n.onActionNotification&&(e=n.onActionNotification(t,n),null!=e&&!e)?!1:void(204===t.status?(n.actionNotification&&null==n.onActionNotification&&alert("Deleted!"),n.table.resetTable()):console.error("unknown status"))}})},this.edit&&null==this.request){if(null!=this.onDelete){if(t=this.onDelete(n,e),null!=t&&!t)return}else if(!confirm("You are sure?"))return;e()}},t.prototype.loadData=function(){var t;t=this,null==this.request&&(this.request=$.getJSON(this.formData.attrs.action,{},function(e){var n,i,a,l,r,o,s,u;for(null!=t.getData&&(e=t.getData(e)),s=t.fields,a=0,r=s.length;r>a;a++)if(n=s[a],null!=n.fields||n instanceof Array)for(u=null!=n.fields?n.fields:n,l=0,o=u.length;o>l;l++)i=u[l],null!=e[i.name]&&t.fieldValue(i,e);else null!=e[n.name]&&t.fieldValue(n,e);t.request=null,t.render()}))},t.prototype.fieldValue=function(t,e){var n;null!=t.name&&null!=e[t.name]&&("related"===t.type&&null!=e[t.text]?t.text=e[t.text]:"date"===t.type&&"Invalid Date"!==new Date(e[t.name]).toString()?e[t.name]=new Date(e[t.name]):"time"===t.type&&e[t.name].length>=4&&(n=e[t.name].match(/(\d{2})(\.\d{3})?/g),e[t.name]=new Date((new Date).toISOString().substr(0,11)+n.join(":")+"Z")),t.value=e[t.name])},t.prototype.sendData=function(){var t,e,n,i,a,l,r,o,s,u;if((null==this.onSubmit||(t=this.onSubmit(this),null==t||t))&&null==this.request){for(n={},u=this,s=this.form.find("[name]"),r=0,o=s.length;o>r;r++)a=s[r],$(a).parent().is(".date-picker")?(l=$(a).attr("name"),$(a).datepicker("getDate")?(i=$(a).datepicker("getDate"),i.setMinutes(-i.getTimezoneOffset()),n[l]=i.toISOString().match(/^[^T]+/g)[0]):n[l]=""):$(a).parent().is(".time-picker")?(l=$(a).attr("name"),$(a).timepicker("getDate")?n[l]=$(a).val().match(/(\d{2}:\d{2}(:\d{2})?)/g):n[l]=""):"checkbox"===$(a).attr("type")?$(a).is(":checked")&&(n[$(a).attr("name")]=$(a).val()?$(a).val():"on"):n[$(a).attr("name")]=$(a).val();e=null!=this.formData.contentType?this.formData.contentType:this.contentType,this.request=$.ajax({url:this.formData.attrs.action,data:"application/json"===e?JSON.stringify(n):n,type:null!=this.formData.attrs.method?this.formData.attrs.method:this.edit?"PUT":"POST",contentType:e,dataType:"json",headers:this.sendCSRFTokenHeader?{"X-CSRFToken":this.getCsrfToken()}:{},complete:function(e){var n,i,l,r,o,s,f;if(u.request=null,null==u.onComplete||(n=u.onComplete(u,e),null==n||n)){if(u.form.find(".field").removeClass("error").find(".error-text").text(""),200===(o=e.status)||201===o){if(u.actionNotification)if(null!=u.onActionNotification){if(t=u.onActionNotification(e,u),null!=t&&!t)return!1}else alert(200===e.status?"Updated!":"Added!");u.table.closeRowContainer(u.form.closest("tr").index(),!0),u.table.resetTable()}else if(400===e.status){"__all__"in e.responseJSON&&(a=u.form.find("[name]"),a.length&&(i=$(a).parent(),i.addClass("error"),i.find(".error-text").text(e.responseJSON.__all__.join(", ")))),s=u.form.find("[name]");for(l=0,r=s.length;r>l;l++)a=s[l],a=$(a),i=a.parent(),i.is(".date-picker")&&(i=i.parent()),a.attr("name")in e.responseJSON&&(i.addClass("error"),f=i.hasClass("multiple")&&i.find(".error-text").text()?i.find(".error-text").text()+", ":"",i.find(".error-text").text(f+e.responseJSON[a.attr("name")].join(", ")))}else console.error("unknown status");null!=u.table&&u.table.body.trigger("scroll")}}})}},t}();
//# sourceMappingURL=TableForm.min.js.map
